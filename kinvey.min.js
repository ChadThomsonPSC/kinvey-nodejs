/*!
 * Copyright (c) 2015 Kinvey, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(){var a=this,b=function(){var c=function(a){var c=b();return null!=a&&c.init(a),c},d=require("loglevel"),e=d.methodFactory;d.methodFactory=function(a,b){var c=e(a,b);return function(a,b){a="Kinvey: "+a,c(a,b)}},c.Log={levels:d.levels,getLevel:function(){return d.getLevel()},setLevel:function(a,b){d.setLevel(a,b)},setDefaultLevel:function(a){d.setDefaultLevel(a)},enableAll:function(a){d.enableAll(a)},disableAll:function(a){d.disableAll(a)}},c.Log.setDefaultLevel(c.Log.levels.ERROR),c.APIHostName="https://baas.kinvey.com",c.API_ENDPOINT=void 0,c.MICHostName="https://auth.kinvey.com",c.MICAPIVersion=void 0,c.API_VERSION="3",c.SDK_VERSION="1.5.0",c.appKey=null,c.appSecret=null,c.masterSecret=null;var f="appdata",g="blob",h="rpc",i="user",j=2e3,k=null,l=!1,m=function(a){var b=D.get("activeUser");return b.then(function(b){if(null==b)return c.setActiveUser(null);d.debug("Restoring the active user.");var e=c.setActiveUser({_id:b[0],_kmd:{authtoken:b[1]}});if(!1===a.refresh)return c.getActiveUser();var f=a.success,g=a.error;return delete a.success,delete a.error,c.User.me(a).then(function(b){return d.debug("Restored the active user.",b),a.success=f,a.error=g,b},function(b){return d.error("Failed to restore the active user.",b),c.Error.INVALID_CREDENTIALS===b.name&&c.setActiveUser(e),a.success=f,a.error=g,c.Defer.reject(b)})})};c.getActiveUser=function(){if(!1===l)throw new c.Error("Kinvey.getActiveUser can only be called after the promise returned by Kinvey.init fulfills or rejects.");return k},c.setActiveUser=function(a){if(d.debug("Setting the active user.",arguments),null!=a&&(null==a._id||null==a._kmd||null==a._kmd.authtoken))throw new c.Error("user argument must contain: _id, _kmd.authtoken.");!1===l&&(l=!0);var b=c.getActiveUser();return k=a,null!=a?D.save("activeUser",[a._id,a._kmd.authtoken]):D.destroy("activeUser"),b},c.init=function(a){var b;if(d.debug("Initializing the copy of the library.",arguments),a=a||{},null==a.appKey)return b=new c.Error("options argument must contain: appKey."),r(c.Defer.reject(b),a);if(null==a.appSecret&&null==a.masterSecret)return b=new c.Error("options argument must contain: appSecret and/or masterSecret."),r(c.Defer.reject(b),a);l=!1;var e=a.apiHostName||c.API_ENDPOINT;if(c.APIHostName=e||c.APIHostName,0!==c.APIHostName.indexOf("https://"))return b=new c.Error("Kinvey requires https as the protocol when setting Kinvey.APIHostName, instead found the protocol "+c.APIHostName.substring(0,c.APIHostName.indexOf(":/"))+" in Kinvey.APIHostName: "+c.APIHostName),r(c.Defer.reject(b),a);if(c.MICHostName=a.micHostName||c.MICHostName,0!==c.MICHostName.indexOf("https://"))return b=new c.Error("Kinvey requires https as the protocol when setting Kinvey.MICHostName, instead found the protocol "+c.MICHostName.substring(0,c.MICHostName.indexOf(":/"))+" in Kinvey.MICHostName: "+c.MICHostName),r(c.Defer.reject(b),a);c.MICAPIVersion=a.micApiVersion||c.MICAPIVersion,null!=a.clientAppVersion&&c.ClientAppVersion.setVersion(a.clientAppVersion),null!=a.customRequestProperties&&c.CustomRequestProperties.setProperties(a.customRequestProperties),c.appKey=a.appKey,c.appSecret=null!=a.appSecret?a.appSecret:null,c.masterSecret=null!=a.masterSecret?a.masterSecret:null,c.encryptionKey=null!=a.encryptionKey?a.encryptionKey:null;var f=V.upgrade().then(function(){return c.Sync.init(a.sync)}).then(function(){return d.debug("Kinvey initialized, running version: js-nodejs/1.5.0"),m(a)});return r(f,a)},c.ping=function(a){d.debug("Pinging the Kinvey service.",arguments),a=a||{},a.nocache=null==c.appKey?!1:a.nocache;var b=c.Persistence.read({namespace:f,auth:null!=c.appKey?F.All:F.None},a);return b.then(function(a){d.debug("Pinged the Kinvey service.",a)},function(a){d.error("Failed to ping the Kinvey service.",a)}),r(b,a)},c.Error=function(a){this.name="Kinvey.Error",this.message=a,this.stack=(new Error).stack,d.error("A Kinvey.Error was thrown.",this.message,this.stack)},c.Error.prototype=new Error,c.Error.prototype.constructor=c.Error,c.Error.ENTITY_NOT_FOUND="EntityNotFound",c.Error.COLLECTION_NOT_FOUND="CollectionNotFound",c.Error.APP_NOT_FOUND="AppNotFound",c.Error.USER_NOT_FOUND="UserNotFound",c.Error.BLOB_NOT_FOUND="BlobNotFound",c.Error.INVALID_CREDENTIALS="InvalidCredentials",c.Error.KINVEY_INTERNAL_ERROR_RETRY="KinveyInternalErrorRetry",c.Error.KINVEY_INTERNAL_ERROR_STOP="KinveyInternalErrorStop",c.Error.USER_ALREADY_EXISTS="UserAlreadyExists",c.Error.USER_UNAVAILABLE="UserUnavailable",c.Error.DUPLICATE_END_USERS="DuplicateEndUsers",c.Error.INSUFFICIENT_CREDENTIALS="InsufficientCredentials",c.Error.WRITES_TO_COLLECTION_DISALLOWED="WritesToCollectionDisallowed",c.Error.INDIRECT_COLLECTION_ACCESS_DISALLOWED="IndirectCollectionAccessDisallowed",c.Error.APP_PROBLEM="AppProblem",c.Error.PARAMETER_VALUE_OUT_OF_RANGE="ParameterValueOutOfRange",c.Error.CORS_DISABLED="CORSDisabled",c.Error.INVALID_QUERY_SYNTAX="InvalidQuerySyntax",c.Error.MISSING_QUERY="MissingQuery",c.Error.JSON_PARSE_ERROR="JSONParseError",c.Error.MISSING_REQUEST_HEADER="MissingRequestHeader",c.Error.INCOMPLETE_REQUEST_BODY="IncompleteRequestBody",c.Error.MISSING_REQUEST_PARAMETER="MissingRequestParameter",c.Error.INVALID_IDENTIFIER="InvalidIdentifier",c.Error.BAD_REQUEST="BadRequest",c.Error.FEATURE_UNAVAILABLE="FeatureUnavailable",c.Error.API_VERSION_NOT_IMPLEMENTED="APIVersionNotImplemented",c.Error.API_VERSION_NOT_AVAILABLE="APIVersionNotAvailable",c.Error.INPUT_VALIDATION_FAILED="InputValidationFailed",c.Error.BL_RUNTIME_ERROR="BLRuntimeError",c.Error.BL_SYNTAX_ERROR="BLSyntaxError",c.Error.BL_TIMEOUT_ERROR="BLTimeoutError",c.Error.OAUTH_TOKEN_REFRESH_ERROR="OAuthTokenRefreshError",c.Error.BL_VIOLATION_ERROR="BLViolationError",c.Error.BL_INTERNAL_ERROR="BLInternalError",c.Error.THIRD_PARTY_TOS_UNACKED="ThirdPartyTOSUnacked",c.Error.STALE_REQUEST="StaleRequest",c.Error.DATA_LINK_PARSE_ERROR="DataLinkParseError",c.Error.NOT_IMPLEMENTED_ERROR="NotImplementedError",c.Error.EMAIL_VERIFICATION_REQUIRED="EmailVerificationRequired",c.Error.SORT_LIMIT_EXCEEDED="SortLimitExceeded",c.Error.INVALID_SHORT_URL="InvalidShortURL",c.Error.INVALID_OR_MISSING_NONCE="InvalidOrMissingNonce",c.Error.MISSING_CONFIGURATION="MissingConfiguration",c.Error.ENDPOINT_DOES_NOT_EXIST="EndpointDoesNotExist",c.Error.DISALLOWED_QUERY_SYNTAX="DisallowedQuerySyntax",c.Error.MALFORMED_AUTHENTICATION_HEADER="MalformedAuthenticationHeader",c.Error.APP_ARCHIVED="AppArchived",c.Error.BL_NOT_SUPPORTED_FOR_ROUTE="BLNotSupportedForRoute",c.Error.USER_LOCKED_DOWN="UserLockedDown",c.Error.ALREADY_LOGGED_IN="AlreadyLoggedIn",c.Error.DATABASE_ERROR="DatabaseError",c.Error.MISSING_APP_CREDENTIALS="MissingAppCredentials",c.Error.MISSING_MASTER_CREDENTIALS="MissingMasterCredentials",c.Error.NO_ACTIVE_USER="NoActiveUser",c.Error.REQUEST_ABORT_ERROR="RequestAbortError",c.Error.REQUEST_ERROR="RequestError",c.Error.REQUEST_TIMEOUT_ERROR="RequestTimeoutError",c.Error.SOCIAL_ERROR="SocialError",c.Error.SYNC_ERROR="SyncError",c.Error.MIC_ERROR="MIC_ERROR";var n={};n[c.Error.ALREADY_LOGGED_IN]={name:c.Error.ALREADY_LOGGED_IN,description:"You are already logged in with another user.",debug:"If you want to switch users, logout the active user first using `Kinvey.User.logout`, then try again."},n[c.Error.DATABASE_ERROR]={name:c.Error.DATABASE_ERROR,description:"The database used for local persistence encountered an error.",debug:""},n[c.Error.MISSING_APP_CREDENTIALS]={name:c.Error.MISSING_APP_CREDENTIALS,description:"Missing credentials: `Kinvey.appKey` and/or `Kinvey.appSecret`.",debug:"Did you forget to call `Kinvey.init`?"},n[c.Error.MISSING_MASTER_CREDENTIALS]={name:c.Error.MISSING_MASTER_CREDENTIALS,description:"Missing credentials: `Kinvey.appKey` and/or `Kinvey.masterSecret`.",debug:"Did you forget to call `Kinvey.init` with your Master Secret?"},n[c.Error.NO_ACTIVE_USER]={name:c.Error.NO_ACTIVE_USER,description:"You need to be logged in to execute this request.",debug:"Try creating a user using `Kinvey.User.signup`, or login an existing user using `Kinvey.User.login`."},n[c.Error.REQUEST_ABORT_ERROR]={name:c.Error.REQUEST_TIMEOUT_ERROR,description:"The request was aborted.",debug:""},n[c.Error.REQUEST_ERROR]={name:c.Error.REQUEST_ERROR,description:"The request failed.",debug:""},n[c.Error.REQUEST_TIMEOUT_ERROR]={name:c.Error.REQUEST_TIMEOUT_ERROR,description:"The request timed out.",debug:""},n[c.Error.SOCIAL_ERROR]={name:c.Error.SOCIAL_ERROR,description:"The social identity cannot be obtained.",debug:""},n[c.Error.SYNC_ERROR]={name:c.Error.SYNC_ERROR,description:"The synchronization operation cannot be completed.",debug:""},n[c.Error.MIC_ERROR]={name:c.Error.MIC_ERROR,description:"Unable to authorize using Mobile Identity Connect.",debug:""};var o,p=function(a,b){var c=n[a]||{name:a};return b=b||{},{name:c.name,description:b.description||c.description||"",debug:b.debug||c.debug||""}},q=function(a,b,c){if(!b)return a="undefined"==typeof c?a:c;for(var d,e=a,f=b.split(".");(d=f.shift())&&null!=e&&e.hasOwnProperty(d);){if(0===f.length)return e[d]="undefined"==typeof c?e[d]:c,e[d];e=e[d]}return null};o="function"==typeof a.setImmediate?a.setImmediate:"undefined"!=typeof process&&process.nextTick?process.nextTick:function(b){a.setTimeout(b,0)};var r=function(a,b){return a.then(function(a){b.success&&b.success(a)},function(a){b.error&&b.error(a)}).then(null,function(a){o(function(){throw a})}),a},s=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},t=function(a){return"function"!=typeof/./?"function"==typeof a:"[object Function]"===Object.prototype.toString.call(a)},u=function(a){return"[object Number]"===Object.prototype.toString.call(a)&&!isNaN(a)},v=function(a){return Object(a)===a},w=function(a){return"[object RegExp]"===Object.prototype.toString.call(a)},x=function(a){return"[object String]"===Object.prototype.toString.call(a)},y=function(a){if(null==a)return!0;if(s(a)||x(a))return 0===a.length;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},z=function(a){return function(){throw new c.Error("Method not implemented: "+a)}},A=function(a){return function(b){var e=this;d.debug("Applying an adapter.",e,b),b=b||{},a.forEach(function(a){if("function"!=typeof b[a])throw new c.Error("Adapter must implement method: "+a)}),a.forEach(function(a){e[a]=function(){return b[a].apply(b,arguments)}})}},B=function(a){var b,c=0,d=a.length;for(a=String(a||""),b=0;d>b;b++){var e=encodeURI(a[b]).split("%").length;c+=1===e?1:e-1}return c},C=function(a){if("string"!=typeof a)return{};if(a=a.trim().replace(/^(\?|#)/,""),!a)return{};var b=a.indexOf("#/");return b===a.length-2&&(a=a.substring(0,b)),a.trim().split("&").reduce(function(a,b){var c=b.replace(/\+/g," ").split("="),d=c[0],e=c[1];return d=decodeURIComponent(d),e=void 0===e?null:decodeURIComponent(e),a.hasOwnProperty(d)?Array.isArray(a[d])?a[d].push(e):a[d]=[a[d],e]:a[d]=e,a},{})},D={destroy:function(a){return D._destroy(D._key(a))},get:function(a){return D._get(D._key(a))},save:function(a,b){return D._save(D._key(a),b)},_destroy:z("Storage.destroy"),_get:z("Storage.get"),_key:function(a){return["Kinvey",c.appKey,a].join(".")},_save:z("Storage.set"),use:A(["_destroy","_get","_save"])};c.Defer={all:function(a){var b;if(!s(a))return b=new c.Error("promises argument must be of type: Array."),c.Defer.reject(b);var d=a.length;if(0===d)return c.Defer.resolve([]);var e=c.Defer.deferred(),f=[];return a.forEach(function(a,b){a.then(function(a){d-=1,f[b]=a,0===d&&e.resolve(f)},function(a){e.reject(a)})}),e.promise},resolve:function(a){var b=c.Defer.deferred();return b.resolve(a),b.promise},reject:function(a){var b=c.Defer.deferred();return b.reject(a),b.promise},deferred:z("Kinvey.Defer.deferred"),use:A(["deferred"])};var E,F={All:function(){return F.Session().then(null,F.Basic)},App:function(){if(null==c.appKey||null==c.appSecret){var a=p(c.Error.MISSING_APP_CREDENTIALS);return c.Defer.reject(a)}var b=c.Defer.resolve({scheme:"Basic",username:c.appKey,password:c.appSecret});return b.then(function(a){d.debug("Authenticating through App Secret.",a)}),b},Basic:function(){return F.Master().then(null,F.App)},Default:function(){return F.Session().then(null,function(a){return F.Master().then(null,function(){return c.Defer.reject(a)})})},Master:function(){if(null==c.appKey||null==c.masterSecret){var a=p(c.Error.MISSING_MASTER_CREDENTIALS);return c.Defer.reject(a)}var b=c.Defer.resolve({scheme:"Basic",username:c.appKey,password:c.masterSecret});return b.then(function(a){d.debug("Authenticating through Master Secret.",a)}),b},None:function(){return c.Defer.resolve(null)},Session:function(){var a,b=c.getActiveUser();if(null===b)return a=p(c.Error.NO_ACTIVE_USER),c.Defer.reject(a);if(null===b._kmd||void 0===b._kmd)return a=new c.Error("The active user does not have _kmd defined as a property.It is required to authenticate the user. User _id: "+b._id),c.Defer.reject(a);var e=c.Defer.resolve({scheme:"Kinvey",credentials:b._kmd.authtoken});return e.then(function(a){d.debug("Authenticating through user credentials.",a)}),e}},G=function(){var b,c,d,e,f,g=[],h=function(a){a=a.toLowerCase();var b=/(chrome)\/([\w]+)/,c=/(firefox)\/([\w.]+)/,d=/(msie) ([\w.]+)/i,e=/(opera)(?:.*version)?[ \/]([\w.]+)/,f=/(safari)\/([\w.]+)/;return b.exec(a)||c.exec(a)||d.exec(a)||e.exec(a)||f.exec(a)||[]};if("undefined"!=typeof a.cordova&&"undefined"!=typeof a.device){var i=a.device;g.push("phonegap/"+i.cordova),c=i.platform,d=i.version,e=i.model,f=i.uuid}else"undefined"!=typeof Titanium?(g.push("titanium/"+Titanium.getVersion()),"mobileweb"===Titanium.Platform.getName()?(b=h(Titanium.Platform.getModel()),c=b[1],d=b[2],e=Titanium.Platform.getOstype()):(c=Titanium.Platform.getOsname(),d=Titanium.Platform.getVersion(),e=Titanium.Platform.getManufacturer()),f=Titanium.Platform.getId()):"undefined"!=typeof forge?(g.push("triggerio/"+(forge.config.platform_version||"")),f=forge.config.uuid):"undefined"!=typeof process&&(c=process.title,d=process.version,e=process.platform);"undefined"!=typeof angular&&g.push("angularjs/"+angular.version.full),"undefined"!=typeof Backbone&&g.push("backbonejs/"+Backbone.VERSION),"undefined"!=typeof Ember&&g.push("emberjs/"+Ember.VERSION),"undefined"!=typeof jQuery&&g.push("jquery/"+jQuery.fn.jquery),"undefined"!=typeof ko&&g.push("knockout/"+ko.version),"undefined"!=typeof Zepto&&g.push("zeptojs"),null==c&&a.navigator&&(b=h(a.navigator.userAgent),c=b[1],d=b[2],e=a.navigator.platform);var j=["js-nodejs/1.5.0"];return 0!==g.length&&j.push("("+g.sort().join(", ")+")"),j.concat([c,d,e,f].map(function(a){return null!=a?a.toString().replace(/\s/g,"_").toLowerCase():"unknown"})).join(" ")},H=function(){var a=arguments[0];if(arguments.length>1){var b=arguments[0],c=arguments[1],d=arguments[2];a=(b+"").trim(),null!=c&&(a+=("."+c).trim()),null!=d&&(a+=("."+d).trim())}return a},I=function(a){return null==a?void 0:(a+"").trim()},J=function(){E=void 0};c.ClientAppVersion={stringValue:function(){return I(E)},setVersion:function(){c.ClientAppVersion.clear(),d.debug("Setting the client app version.",arguments),E=H.apply(a,arguments)},clear:function(){d.debug("Clearing the client app version."),J()}};var K={},L=function(a){null!=a&&K.hasOwnProperty(a)&&delete K[a]},M=function(){K={}};c.CustomRequestProperties={properties:function(){return JSON.parse(JSON.stringify(K))},property:function(a){return null!=a&&K.hasOwnProperty(a)?K[a]:void 0},setProperties:function(a){c.CustomRequestProperties.clear(),c.CustomRequestProperties.addProperties(a)},setProperty:function(a,b){var d={};d[a]=b,c.CustomRequestProperties.addProperties(d)},addProperties:function(a){null!=a&&Object.keys(a).forEach(function(b){var c=a[b];d.debug("Adding custom request property "+b+" as "+c+"."),K[b]=c})},clear:function(){d.debug("Clearing the custom request properties."),M()},clearProperty:function(a){d.debug("Clearing the custom request property "+a+"."),L(a)}},c.Acl=function(a){if(null!=a&&!v(a))throw new c.Error("document argument must be of type: Object.");a=a||{},a._acl=a._acl||{},this._acl=a._acl},c.Acl.prototype={addReader:function(a){return this._acl.r=this._acl.r||[],-1===this._acl.r.indexOf(a)&&this._acl.r.push(a),this},addReaderGroup:function(a){return this._acl.groups=this._acl.groups||{},this._acl.groups.r=this._acl.groups.r||[],-1===this._acl.groups.r.indexOf(a)&&this._acl.groups.r.push(a),this},addWriterGroup:function(a){return this._acl.groups=this._acl.groups||{},this._acl.groups.w=this._acl.groups.w||[],-1===this._acl.groups.w.indexOf(a)&&this._acl.groups.w.push(a),this},addWriter:function(a){return this._acl.w=this._acl.w||[],-1===this._acl.w.indexOf(a)&&this._acl.w.push(a),this},getCreator:function(){return this._acl.creator||null},getReaders:function(){return this._acl.r||[]},getReaderGroups:function(){return this._acl.groups?this._acl.groups.r:[]},getWriterGroups:function(){return this._acl.groups?this._acl.groups.w:[]},getWriters:function(){return this._acl.w||[]},isGloballyReadable:function(){return this._acl.gr||!1},isGloballyWritable:function(){return this._acl.gw||!1},removeReader:function(a){var b;return this._acl.r&&-1!==(b=this._acl.r.indexOf(a))&&this._acl.r.splice(b,1),this},removeReaderGroup:function(a){var b;return this._acl.groups&&this._acl.groups.r&&-1!==(b=this._acl.groups.r.indexOf(a))&&this._acl.groups.r.splice(b,1),this},removeWriterGroup:function(a){var b;return this._acl.groups&&this._acl.groups.w&&-1!==(b=this._acl.groups.w.indexOf(a))&&this._acl.groups.w.splice(b,1),this},removeWriter:function(a){var b;return this._acl.w&&-1!==(b=this._acl.w.indexOf(a))&&this._acl.w.splice(b,1),this},setGloballyReadable:function(a){return this._acl.gr=a||!1,this},setGloballyWritable:function(a){return this._acl.gw=a||!1,this},toJSON:function(){return this._acl}},c.Group=function(){this._query=null,this._initial={},this._key={},this._reduce=function(){}.toString()},c.Group.prototype={by:function(a){return this._key[a]=!0,this},initial:function(a,b){if("undefined"==typeof b&&!v(a))throw new c.Error("objectOrKey argument must be of type: Object.");return v(a)?this._initial=a:this._initial[a]=b,this},postProcess:function(a){return null===this._query?a:this._query._postProcess(a)},query:function(a){if(!(a instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");return this._query=a,this},reduce:function(a){if(t(a)&&(a=a.toString()),!x(a))throw new c.Error("fn argument must be of type: function or string.");return this._reduce=a,this},toJSON:function(){return{key:this._key,initial:this._initial,reduce:this._reduce,condition:null!==this._query?this._query.toJSON().filter:{}}}},c.Group.count=function(a){var b=new c.Group;return null!=a&&b.by(a),b.initial({result:0}),b.reduce(function(a,b){b.result+=1}),b},c.Group.sum=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({result:0}),b.reduce('function(doc, out) { out.result += doc["'+a+'"]; }'),b},c.Group.min=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({result:"Infinity"}),b.reduce('function(doc, out) { out.result = Math.min(out.result, doc["'+a+'"]); }'),b},c.Group.max=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({result:"-Infinity"}),b.reduce('function(doc, out) { out.result = Math.max(out.result, doc["'+a+'"]); }'),b},c.Group.average=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({count:0,result:0}),b.reduce('function(doc, out) {  out.result = (out.result * out.count + doc["'+a+'"]) / (out.count + 1);  out.count += 1;}'),b},c.execute=function(a,b,e){d.debug("Executing custom command.",arguments),e=e||{};var f=c.Persistence.create({namespace:h,collection:"custom",id:a,data:b,auth:F.Default},e).then(null,function(a){return c.Defer.reject(c.Error.REQUEST_ERROR===a.name&&v(a.debug)?a.debug:a)});return f.then(function(a){d.debug("Executed the custom command.",a)},function(a){d.error("Failed to execute the custom command.",a)}),r(f,e)},c.DataStore={find:function(a,b,e){var g;if(d.debug("Retrieving documents by query.",arguments),null!=b&&!(b instanceof c.Query))return g=new c.Error("query argument must be of type: Kinvey.Query."),r(c.Defer.reject(g),e);e=e||{};var h=c.Persistence.read({namespace:f,collection:a,query:b,auth:F.Default,local:{req:!0,res:!0}},e);return h.then(function(a){d.debug("Retrieved the documents by query.",a)},function(a){d.error("Failed to retrieve the documents by query.",a)}),r(h,e)},get:function(a,b,e){d.debug("Retrieving a document.",arguments),e=e||{};var g=c.Persistence.read({namespace:f,collection:a,id:b,auth:F.Default,local:{req:!0,res:!0}},e);return g.then(function(a){d.debug("Retrieved the document.",a)},function(a){d.error("Failed to retrieve the document.",a)}),r(g,e)},save:function(a,b,e){if(d.debug("Saving a (new) document.",arguments),e=e||{},null!=b._id)return d.debug("The document has an _id, updating instead.",arguments),c.DataStore.update(a,b,e);var g=c.Persistence.create({namespace:f,collection:a,data:b,auth:F.Default,local:{req:!0,res:!0}},e);return g.then(function(a){d.debug("Saved the new document.",a)},function(a){d.error("Failed to save the new document.",a)}),r(g,e)},update:function(a,b,e){var g;if(d.debug("Updating a document.",arguments),null==b._id)return g=new c.Error("document argument must contain: _id"),r(c.Defer.reject(g),e);e=e||{};var h=c.Persistence.update({namespace:f,collection:a,id:b._id,data:b,auth:F.Default,local:{req:!0,res:!0}},e);return h.then(function(a){d.debug("Updated the document.",a)},function(a){d.error("Failed to update the document.",a)}),r(h,e)},clean:function(a,b,e){var g;if(d.debug("Deleting documents by query.",arguments),e=e||{},b=b||new c.Query,!(b instanceof c.Query))return g=new c.Error("query argument must be of type: Kinvey.Query."),r(c.Defer.reject(g),e);var h=c.Persistence.destroy({namespace:f,collection:a,query:b,auth:F.Default,local:{req:!0,res:!0}},e);return h.then(function(a){d.debug("Deleted the documents.",a)},function(a){d.error("Failed to delete the documents.",a)}),r(h,e)},destroy:function(a,b,e){d.debug("Deleting a document.",arguments),e=e||{};var g=c.Persistence.destroy({namespace:f,collection:a,id:b,auth:F.Default,local:{req:!0,res:!0}},e).then(null,function(a){return e.silent&&c.Error.ENTITY_NOT_FOUND===a.name?(d.debug("The document does not exist. Returning success because of the silent flag."),{count:0}):c.Defer.reject(a)});return g.then(function(a){d.debug("Deleted the document.",a)},function(a){d.error("Failed to delete the document.",a)}),r(g,e)},count:function(a,b,e){var g;if(d.debug("Counting the number of documents.",arguments),null!=b&&!(b instanceof c.Query))return g=new c.Error("query argument must be of type: Kinvey.Query."),r(c.Defer.reject(g),e);e=e||{};var h=c.Persistence.read({namespace:f,collection:a,id:"_count",query:b,auth:F.Default,local:{req:!0}},e).then(function(a){return a.count});return h.then(function(a){d.debug("Counted the number of documents.",a)},function(a){d.error("Failed to count the number of documents.",a)}),r(h,e)},group:function(a,b,e){var g;if(d.debug("Grouping documents",arguments),!(b instanceof c.Group))return g=new c.Error("aggregation argument must be of type: Kinvey.Group."),r(c.Defer.reject(g),e);e=e||{};var h=c.Persistence.create({namespace:f,collection:a,id:"_group",data:b.toJSON(),auth:F.Default,local:{req:!0}},e).then(function(a){return b.postProcess(a)});return h.then(function(a){d.debug("Grouped the documents.",a)},function(a){d.error("Failed to group the documents.",a)}),r(h,e)}},c.File={destroy:function(a,b){d.debug("Deleting a file.",arguments),b=b||{};var e=c.Persistence.destroy({namespace:g,id:a,auth:F.Default},b).then(null,function(a){return b.silent&&c.Error.BLOB_NOT_FOUND===a.name?(d.debug("The file does not exist. Returning success because of the silent flag."),{count:0}):c.Defer.reject(a)});return e.then(function(a){d.debug("Deleted the file.",a)},function(a){d.error("Failed to delete the file.",a)}),r(e,b)},download:function(a,b){d.debug("Downloading a file.",arguments),b=b||{};var e={};!1!==b.tls&&(e.tls=!0),b.ttl&&(e.ttl_in_seconds=b.ttl);var f=c.Persistence.read({namespace:g,id:a,flags:e,auth:F.Default},b).then(function(a){if(b.stream)return d.debug("Returning the file metadata only because of the stream flag."),a;var e=b.success,f=b.error;return delete b.success,delete b.error,c.File.downloadByUrl(a,b).then(function(a){return b.success=e,b.error=f,a},function(a){return b.success=e,b.error=f,c.Defer.reject(a)})});return f.then(function(a){d.debug("Downloaded the file.",a)},function(a){d.error("Failed to download the file.",a)}),r(f,b)},downloadByUrl:function(a,b){d.debug("Downloading a file by URL.",arguments);var e=v(a)?a:{_downloadURL:a};b=b||{},b.file=e.mimeType||"application-octet-stream",b.headers=b.headers||{},delete b.headers["Content-Type"];var f=e._downloadURL,g=c.Persistence.Net.request("GET",f,null,b.headers,b);return g=g.then(function(a){return e._data=a,e},function(a){var b=p(c.Error.REQUEST_ERROR,{description:"This file could not be downloaded from the provided URL.",debug:a});return c.Defer.reject(b)}),g.then(function(a){d.debug("Downloaded the file by URL.",a)},function(a){d.error("Failed to download a file by URL.",a)}),r(g,b)},find:function(a,b){var e;if(d.debug("Retrieving files by query.",arguments),null!=a&&!(a instanceof c.Query))return e=new c.Error("query argument must be of type: Kinvey.Query."),r(c.Defer.reject(e),b);b=b||{};var f={};!1!==b.tls&&(f.tls=!0),b.ttl&&(f.ttl_in_seconds=b.ttl);var h=c.Persistence.read({namespace:g,query:a,flags:f,auth:F.Default},b).then(function(a){if(b.download){d.debug("Obtaining the file resources.",a);var e=b.success,f=b.error;delete b.success,delete b.error;var g=a.map(function(a){return c.File.downloadByUrl(a,b)});return c.Defer.all(g).then(function(a){return b.success=e,b.error=f,a},function(a){return b.success=e,b.error=f,c.Defer.reject(a)})}return a});return h.then(function(a){d.debug("Retrieved the files by query.",a)},function(a){d.error("Failed to retrieve the files by query.",a)}),r(h,b)},stream:function(a,b){return d.debug("Streaming a file.",arguments),b=b||{},b.stream=!0,c.File.download(a,b)},upload:function(a,b,e){d.debug("Uploading a file.",arguments),a=a||{},b=b||{},e=e||{},null!=b._filename||null==a._filename&&null==a.name||(b._filename=a._filename||a.name),null!=b.size||null==a.size&&null==a.length||(b.size=a.size||a.length),b.mimeType=b.mimeType||a.mimeType||a.type||"application/octet-stream",e["public"]&&(b._public=!0),e.contentType=b.mimeType;var f=null!=b._id?c.Persistence.update({namespace:g,id:b._id,data:b,flags:!1!==e.tls?{tls:!0}:null,auth:F.Default},e):c.Persistence.create({namespace:g,data:b,flags:!1!==e.tls?{tls:!0}:null,auth:F.Default},e);return f=f.then(function(b){var d=b._uploadURL,f=b._requiredHeaders||{};f["Content-Type"]=e.contentType,delete b._expiresAt,delete b._requiredHeaders,delete b._uploadURL;var g=c.Persistence.Net.request("PUT",d,a,f,e);return g.then(function(){return b._data=a,b})}),f.then(function(a){d.debug("Uploaded the file.",a)},function(a){d.error("Failed to upload the file.",a)}),r(f,e)}};var N=function(b){var c=Date.parse(b);if(c)return new Date(c);var d=/^(\d{4}\-\d\d\-\d\d([tT][\d:\.]*)?)([zZ]|([+\-])(\d\d):?(\d\d))?$/,e=b.match(d);if(null!=e[1]){var f=e[1].split(/\D/).map(function(b){return a.parseInt(b,10)||0});if(f[1]-=1,f=new Date(Date.UTC.apply(Date,f)),null!=e[5]){var g=a.parseInt(e[5],10)/100*60;g+=null!=e[6]?a.parseInt(e[6],10):0,g*="+"===e[4]?-1:1,g&&f.setUTCMinutes(f.getUTCMinutes()*g)}return f}return 0/0};c.Metadata=function(a){if(!v(a))throw new c.Error("document argument must be of type: Object.");this._acl=null,this._document=a},c.Metadata.prototype={getAcl:function(){return null===this._acl&&(this._acl=new c.Acl(this._document)),this._acl},getCreatedAt:function(){return null!=this._document._kmd&&null!=this._document._kmd.ect?N(this._document._kmd.ect):null},getEmailVerification:function(){return null!=this._document._kmd&&null!=this._document._kmd.emailVerification?this._document._kmd.emailVerification.status:null},getLastModified:function(){return null!=this._document._kmd&&null!=this._document._kmd.lmt?N(this._document._kmd.lmt):null},setAcl:function(a){if(!(a instanceof c.Acl))throw new c.Error("acl argument must be of type: Kinvey.Acl.");return this._acl=null,this._document._acl=a.toJSON(),this},toJSON:function(){return this._document}};var O=["facebook","google","linkedIn","twitter"],P={use:A(O)};O.forEach(function(a){P[a]=z("Social."+a)}),c.Social={connect:function(a,b,e){var f;if(d.debug("Linking a social identity to a Kinvey user.",arguments),e=e||{},e.create="undefined"!=typeof e.create?e.create:!0,!c.Social.isSupported(b))return f=new c.Error("provider argument is not supported."),r(c.Defer.reject(f),e);var g=e.success;f=e.error,delete e.success,delete e.error;var h=P[b](e).then(function(d){a=a||{};var g=c.getActiveUser();if(a._socialIdentity=a._socialIdentity||{},a._socialIdentity[b]=d,null!==g){if(null==g._id)throw f=new c.Error("Active user does not have _id property defined.");if(g._id===a._id)return e._provider=b,c.User.update(a,e)}return a._socialIdentity={},a._socialIdentity[b]=d,c.User.login(a,null,e).then(null,function(b){return e.create&&c.Error.USER_NOT_FOUND===b.name?c.User.signup(a,e):c.Defer.reject(b)})});return h=h.then(function(a){return e.success=g,e.error=f,a}),h.then(function(a){d.debug("Linked the social identity to the Kinvey user.",a)},function(a){d.error("Failed to link a social identity to a Kinvey user.",a)}),r(h,e)},disconnect:function(a,b,e){var f;if(d.debug("Unlinking a social identity from a Kinvey user.",arguments),!c.Social.isSupported(b))return f=new c.Error("provider argument is not supported."),r(c.Defer.reject(f),e);if(a._socialIdentity=a._socialIdentity||{},a._socialIdentity[b]=null,null==a._id){var g=c.Defer.resolve(a);return r(g,e)}return c.User.update(a,e)},facebook:function(a,b){return d.debug("Linking a Facebook identity to a Kinvey user.",arguments),c.Social.connect(a,"facebook",b)},google:function(a,b){return d.debug("Linking a Google+ identity to a Kinvey user.",arguments),c.Social.connect(a,"google",b)},isSupported:function(a){return-1!==O.indexOf(a)},linkedIn:function(a,b){return d.debug("Linking a LinkedIn identity to a Kinvey user.",arguments),c.Social.connect(a,"linkedIn",b)},twitter:function(a,b){return d.debug("Linking a Twitter identity to a Kinvey user.",arguments),c.Social.connect(a,"twitter",b)}},c.User={signup:function(a,b){return d.debug("Signing up a new user.",arguments),b=b||{},b.state=!0,c.User.create(a,b)},signupWithProvider:function(a,b,e){d.debug("Signing up a new user with a provider.",arguments);var f={_socialIdentity:{}};return f._socialIdentity[a]=b,c.User.signup(f,e)},login:function(a,b,e){var f;if(d.debug("Logging in an existing user.",arguments),v(a)?e="undefined"!=typeof e?e:b:a={username:a,password:b},e=e||{},(null==a.username||null==a.password)&&null==a._socialIdentity)return f=new c.Error("Username and/or password missing. Please provide both a username and password to login."),r(c.Defer.reject(f),e);if(null!==c.getActiveUser())return f=p(c.Error.ALREADY_LOGGED_IN),r(c.Defer.reject(f),e);var g=c.Persistence.create({namespace:i,collection:e._provider?null:"login",data:a,flags:e._provider?{provider:e._provider}:{},auth:F.App,local:{res:!0}},e).then(function(a){return c.setActiveUser(a),a});return g.then(function(a){d.debug("Logged in the user.",a)},function(a){d.error("Failed to login the user.",a)}),r(g,e)},loginWithProvider:function(a,b,e){d.debug("Logging in with a provider.",arguments);var f={_socialIdentity:{}};return f._socialIdentity[a]=b,c.User.login(f,e)},logout:function(a){a=a||{};var b;return null===c.getActiveUser()?b=c.Defer.resolve(null):(d.debug("Logging out the active user.",arguments),b=c.Persistence.create({namespace:i,collection:"_logout",auth:F.Session},a).then(null,function(a){return c.Error.INVALID_CREDENTIALS===a.name||c.Error.EMAIL_VERIFICATION_REQUIRED===a.name?(d.error("The user credentials are invalid. Returning success because of the force flag."),
null):c.Defer.reject(a)}).then(function(){return Q.disconnect()}).then(function(){var a,b=c.setActiveUser(null);if(null==b._kmd)throw a=new c.Error("The previous active user does not have _kmd definedas a property.");return null!==b&&delete b._kmd.authtoken,b}),b.then(function(a){d.debug("Logged out the active user.",a)},function(a){d.error("Failed to logout the active user.",a)})),r(b,a)},me:function(a){d.debug("Retrieving information on the active user.",arguments),a=a||{};var b=c.Persistence.read({namespace:i,collection:"_me",auth:F.Session,local:{req:!0,res:!0}},a).then(function(a){return a._kmd=a._kmd||{},null==a._kmd.authtoken&&(a._kmd.authtoken=c.getActiveUser()._kmd.authtoken),c.setActiveUser(a),a});return b.then(function(a){d.debug("Retrieved information on the active user.",a)},function(a){d.error("Failed to retrieve information on the active user.",a)}),r(b,a)},verifyEmail:function(a,b){d.debug("Requesting e-mail verification.",arguments),b=b||{};var e=c.Persistence.create({namespace:h,collection:a,id:"user-email-verification-initiate",auth:F.App},b);return e.then(function(a){d.debug("Requested e-mail verification.",a)},function(a){d.error("Failed to request e-mail verification.",a)}),r(e,b)},forgotUsername:function(a,b){d.debug("Requesting a username reminder.",arguments),b=b||{};var e=c.Persistence.create({namespace:h,id:"user-forgot-username",data:{email:a},auth:F.App},b);return e.then(function(a){d.debug("Requested a username reminder.",a)},function(a){d.error("Failed to request a username reminder.",a)}),r(e,b)},resetPassword:function(a,b){d.debug("Requesting a password reset.",arguments),b=b||{};var e=c.Persistence.create({namespace:h,collection:a,id:"user-password-reset-initiate",auth:F.App},b);return e.then(function(a){d.debug("Requested a password reset.",a)},function(a){d.error("Failed to request a password reset.",a)}),r(e,b)},exists:function(a,b){d.debug("Checking whether a username exists.",arguments),b=b||{};var e=c.Persistence.create({namespace:h,id:"check-username-exists",data:{username:a},auth:F.App},b).then(function(a){return a.usernameExists});return e.then(function(a){d.debug("Checked whether the username exists.",a)},function(a){d.error("Failed to check whether the username exists.",a)}),r(e,b)},create:function(a,b){if(d.debug("Creating a new user.",arguments),b=b||{},!1!==b.state&&null!==c.getActiveUser()){var e=p(c.Error.ALREADY_LOGGED_IN);return r(c.Defer.reject(e),b)}var f=c.Persistence.create({namespace:i,data:a||{},auth:F.App},b).then(function(a){return!1!==b.state&&c.setActiveUser(a),a});return f.then(function(a){d.debug("Created the new user.",a)},function(a){d.error("Failed to create the new user.",a)}),r(f,b)},update:function(a,b){var e;if(d.debug("Updating a user.",arguments),null==a._id)return e=new c.Error("data argument must contain: _id"),r(c.Defer.reject(e),b);b=b||{};var f=[];if(null!=a._socialIdentity)for(var g in a._socialIdentity)a._socialIdentity.hasOwnProperty(g)&&null!=a._socialIdentity[g]&&g!==b._provider&&(f.push({provider:g,access_token:a._socialIdentity[g].access_token,access_token_secret:a._socialIdentity[g].access_token_secret}),delete a._socialIdentity[g].access_token,delete a._socialIdentity[g].access_token_secret);var h=c.Persistence.update({namespace:i,id:a._id,data:a,auth:F.Default,local:{res:!0}},b).then(function(a){f.forEach(function(b){var c=b.provider;null!=a._socialIdentity&&null!=a._socialIdentity[c]&&["access_token","access_token_secret"].forEach(function(d){null!=b[d]&&(a._socialIdentity[c][d]=b[d])})});var b=c.getActiveUser();if(null!==b){if(null==b._id)throw e=new c.Error("Active user does not have _id property defined.");if(null==a._id)throw e=new c.Error("User does not have _id property defined.");b._id===a._id&&(d.debug("Updating the active user because the updated user was the active user."),c.setActiveUser(a))}return a});return h.then(function(a){d.debug("Updated the user.",a)},function(a){d.error("Failed to update the user.",a)}),r(h,b)},find:function(a,b){var e;if(d.debug("Retrieving users by query.",arguments),null!=a&&!(a instanceof c.Query))return e=new c.Error("query argument must be of type: Kinvey.Query."),r(c.Defer.reject(e),b);b=b||{};var f;return b.discover?(d.debug("Using User Discovery because of the discover flag."),f=c.Persistence.create({namespace:i,collection:"_lookup",data:null!=a?a.toJSON().filter:null,auth:F.Default,local:{req:!0,res:!0}},b)):f=c.Persistence.read({namespace:i,query:a,auth:F.Default,local:{req:!0,res:!0}},b),f.then(function(a){d.debug("Retrieved the users by query.",a)},function(a){d.error("Failed to retrieve the users by query.",a)}),r(f,b)},get:function(a,b){d.debug("Retrieving a user.",arguments),b=b||{};var e=c.Persistence.read({namespace:i,id:a,auth:F.Default,local:{req:!0,res:!0}},b);return e.then(function(a){d.debug("Retrieved the user.",a)},function(a){d.error("Failed to return the user.",a)}),r(e,b)},destroy:function(a,b){var e;d.debug("Deleting a user.",arguments),b=b||{};var f=c.Persistence.destroy({namespace:i,id:a,flags:b.hard?{hard:!0}:{},auth:F.Default,local:{res:!0}},b).then(function(b){var f=c.getActiveUser();if(null!==f){if(null==f._id)throw e=new c.Error("Active user does not have _id property defined.");f._id===a&&(d.debug("Deleting the active user because the deleted user was the active user."),c.setActiveUser(null))}return b},function(a){return b.silent&&c.Error.USER_NOT_FOUND===a.name?(d.debug("The user does not exist. Returning success because of the silent flag."),null):c.Defer.reject(a)});return f.then(function(a){d.debug("Deleted the user.",a)},function(a){d.error("Failed to delete the user.",a)}),r(f,b)},restore:function(a,b){d.debug("Restoring a previously disabled user.",arguments),b=b||{};var e=c.Persistence.create({namespace:i,collection:a,id:"_restore",auth:F.Master},b);return e.then(function(a){d.debug("Restored the previously disabled user.",a)},function(a){d.error("Failed to restore the previously disabled user.",a)}),r(e,b)},count:function(a,b){var e;if(d.debug("Counting the number of users.",arguments),null!=a&&!(a instanceof c.Query))return e=new c.Error("query argument must be of type: Kinvey.Query."),r(c.Defer.reject(e),b);b=b||{};var f=c.Persistence.read({namespace:i,id:"_count",query:a,auth:F.Default,local:{req:!0}},b).then(function(a){return a.count});return f.then(function(a){d.debug("Counted the number of users.",a)},function(a){d.error("Failed to count the number of users.",a)}),r(f,b)},group:function(a,b){var e;if(d.debug("Grouping users.",arguments),!(a instanceof c.Group))return e=new c.Error("aggregation argument must be of type: Kinvey.Group."),r(c.Defer.reject(e),b);b=b||{};var f=c.Persistence.create({namespace:i,id:"_group",data:a.toJSON(),auth:F.Default,local:{req:!0}},b).then(function(b){return a.postProcess(b)});return f.then(function(a){d.debug("Grouped the users.",a)},function(a){d.error("Failed to group the users.",a)}),r(f,b)}};var Q={AUTH_PATH:"/oauth/auth",TOKEN_PATH:"/oauth/token",AUTH_PROVIDER:"kinveyAuth",TOKEN_STORAGE_KEY:"micToken",AUTH_TIMEOUT:3e5,AuthorizationGrant:{AuthorizationCodeLoginPage:"AuthorizationCodeLoginPage",AuthorizationCodeAPI:"AuthorizationCodeAPI"},login:function(a,b,d){var e,f,g=c.appKey,h=c.getActiveUser();if(d=d||{},d.timeout=d.timeout||Q.AUTH_TIMEOUT,d.attemptMICRefresh=!1,null!=h)return e=p(c.Error.ALREADY_LOGGED_IN),r(c.Defer.reject(e),d);if(null==b)return e=new c.Error("A redirect uri must be provided to login with MIC."),r(c.Defer.reject(e),d);if(Q.AuthorizationGrant.AuthorizationCodeLoginPage===a){if(this.isNode())return e=new c.Error(Q.AuthorizationGrant.AuthorizationCodeLoginPage+" grant is not supported."),r(c.Defer.reject(e),d);f=Q.requestCodeWithPopup(g,b,d)}else{if(Q.AuthorizationGrant.AuthorizationCodeAPI!==a)return e=p(c.Error.MIC_ERROR,{debug:"The authorization grant "+a+" is unrecognized. Please provide one of the following authorization grants: "+Q.AuthorizationGrant.AuthorizationCodeLoginPage+", "+Q.AuthorizationGrant.AuthorizationCodeAPI+"."}),r(c.Defer.reject(e),d);if(this.isHTML5()||this.isAngular()||this.isBackbone()||this.isPhoneGap()||this.isTitanium())return e=new c.Error(Q.AuthorizationGrant.AuthorizationCodeAPI+" grant is not supported."),r(c.Defer.reject(e),d);if(null==d.username)return e=new c.Error("A username must be provided to login with MIC using the "+Q.AuthorizationGrant.AuthorizationCodeAPI+" grant."),r(c.Defer.reject(e),d);if(null==d.password)return e=new c.Error("A password must be provided to login with MIC using the "+Q.AuthorizationGrant.AuthorizationCodeAPI+" grant."),r(c.Defer.reject(e),d);f=Q.requestUrl(g,b,d).then(function(a){return Q.requestCodeWithUrl(a,g,b,d)})}return f=f.then(function(a){return Q.requestToken(g,b,a,d)}).then(function(a){return d.create=!1===d.create?!1:!0,Q.connect(h,a.access_token,d).then(function(c){return D.save(Q.TOKEN_STORAGE_KEY,{refresh_token:a.refresh_token,redirect_uri:b}).then(function(){return c})})}),r(f,d)},refresh:function(a){var b,d,e,f=c.appKey,g=c.getActiveUser();return a=a||{},a.attemptMICRefresh=!1,e=D.get(Q.TOKEN_STORAGE_KEY).then(function(e){if(null!=e)return d=e.redirect_uri,Q.refreshToken(f,d,e.refresh_token,a);throw b=p(c.Error.MIC_ERROR,{debug:"Unable to refresh because there is not a valid refresh token available."})}).then(function(b){return Q.connect(g,b.access_token,a).then(function(a){return D.save(Q.TOKEN_STORAGE_KEY,{refresh_token:b.refresh_token,redirect_uri:d}).then(function(){return a})})},function(a){return D.destroy(Q.TOKEN_STORAGE_KEY).then(function(){throw a})}),r(e,a)},requestUrl:function(a,b,d){var e=c.MICHostName;if(d.micApiVersion=d.micApiVersion||c.MICAPIVersion,null!=d.micApiVersion){var f=d.micApiVersion+"";f=0===f.indexOf("v")?f:"v"+f,e=e+"/"+f}var g={method:"POST",url:e+Q.AUTH_PATH,data:{client_id:a,redirect_uri:b,response_type:"code"},headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","X-Kinvey-API-Version":c.API_VERSION,"X-Kinvey-Device-Information":G()}};return c.Log.getLevel()===c.Log.levels.TRACE&&(g.headers["X-Kinvey-Trace-Request"]="true",g.headers["X-Kinvey-Force-Debug-Log-Credentials"]="true"),c.Persistence.Net.request(g.method,g.url,Q.encodeFormData(g.data),g.headers,d).then(function(a){try{a=JSON.parse(a)}catch(b){}return a.temp_login_uri})},requestCodeWithPopup:function(b,d,e){var f,g=c.Defer.deferred(),h=c.MICHostName;if(e.micApiVersion=e.micApiVersion||c.MICAPIVersion,null!=e.micApiVersion){var i=e.micApiVersion+"";i=0===i.indexOf("v")?i:"v"+i,h=h+"/"+i}h=h+Q.AUTH_PATH+"?client_id="+encodeURIComponent(b)+"&redirect_uri="+encodeURIComponent(d)+"&response_type=code";var j,k,l,m=!1;e=e||{},e.url=e.url||h;var n=function(a){var b=!1;try{b=0===a.url.indexOf(d)}catch(c){}if(b){var e="?"+a.url.split("?")[1],f=C(e);g.resolve(f.code),m=!0,setTimeout(function(){j.close()},200)}},o=function(){m||(f=p(c.Error.MIC_ERROR,{debug:"The popup was closed without authorizing the user."}),g.reject(f)),Q.isPhoneGap()?(j.removeEventListener("loadstart",n),j.removeEventListener("exit",o)):Q.isTitanium()&&(k.removeEventListener("load",n),k.removeEventListener("error",n),j.removeEventListener("close",o),"iPhone OS"===Titanium.Platform.name?l.removeEventListener("click",q):"Android"===Titanium.Platform.name&&(j.close(),j.removeEventListener("androidback",o)))},q=function(){j.close()};if(Q.isPhoneGap())j=a.open(e.url,"_blank","location=yes"),null==j?(f=p(c.Error.MIC_ERROR,{debug:"The popup was blocked."}),g.reject(f)):(j.addEventListener("loadstart",n),j.addEventListener("exit",o));else if(Q.isTitanium()){if(k=Titanium.UI.createWebView({width:"100%",height:"100%",url:e.url}),j=Titanium.UI.createWindow({backgroundColor:"white",barColor:"#000",title:"Kinvey - MIC",modal:!0}),j.add(k),"iPhone OS"===Titanium.Platform.name){var r=Titanium.UI.createWindow({backgroundColor:"white",barColor:"#e3e3e3",title:"Kinvey - MIC"});r.add(k),l=Titanium.UI.createButton({title:"Close",style:Titanium.UI.iPhone.SystemButtonStyle.DONE}),r.setLeftNavButton(l),l.addEventListener("click",q),j=Titanium.UI.iOS.createNavigationWindow({backgroundColor:"white",window:r,modal:!0})}else"Android"===Titanium.Platform.name&&j.addEventListener("androidback",o);j.open(),k.addEventListener("load",n),k.addEventListener("error",n),j.addEventListener("close",o)}else{j=a.open(e.url,"_blank","toolbar=no,location=no");var s=0,t=100,u=a.setInterval(function(){if(null==j)a.clearTimeout(u),f=p(c.Error.MIC_ERROR,{debug:"The popup was blocked."}),g.reject(f);else if(j.closed)a.clearTimeout(u),f=p(c.Error.MIC_ERROR,{debug:"The popup was closed without authorizing the user."}),g.reject(f);else if(e.timeout&&s>e.timeout)a.clearTimeout(u),j.close(),f=p(c.Error.MIC_ERROR,{debug:"The authorization request timed out."}),g.reject(f);else{var b=!1;try{b=0===j.location.href.indexOf(d)}catch(h){}if(b){a.clearTimeout(u);var i=C(j.location.search);g.resolve(i.code),m=!0,j.close()}}s+=t},t)}return g.promise},requestCodeWithUrl:function(a,b,d,e){var f={method:"POST",url:a,data:{client_id:b,redirect_uri:d,response_type:"code",username:e.username,password:e.password},headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"}};return c.Persistence.Net.request(f.method,f.url,Q.encodeFormData(f.data),f.headers,e).then(function(a){try{a=JSON.parse(a)}catch(b){}return a.code},function(a){throw a=p(c.Error.MIC_ERROR,{debug:"Unable to authorize user with username "+e.username+" and password "+e.password+"."})})},requestToken:function(a,b,d,e){var f={auth:F.App,method:"POST",url:c.MICHostName+Q.TOKEN_PATH,data:{grant_type:"authorization_code",client_id:a,redirect_uri:b,code:d},headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","X-Kinvey-API-Version":c.API_VERSION,"X-Kinvey-Device-Information":G()}};return c.Log.getLevel()===c.Log.levels.TRACE&&(f.headers["X-Kinvey-Trace-Request"]="true",f.headers["X-Kinvey-Force-Debug-Log-Credentials"]="true"),f.auth().then(function(a){if(null!==a){var b=a.credentials;null!=a.username&&(b=c.Persistence.Net.base64(a.username+":"+a.password)),f.headers.Authorization=a.scheme+" "+b}return c.Persistence.Net.request(f.method,f.url,Q.encodeFormData(f.data),f.headers,e)}).then(function(a){try{a=JSON.parse(a)}catch(b){}return a})},refreshToken:function(a,b,d,e){var f={auth:F.App,method:"POST",url:c.MICHostName+Q.TOKEN_PATH,data:{grant_type:"refresh_token",client_id:a,redirect_uri:b,refresh_token:d},headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","X-Kinvey-API-Version":c.API_VERSION,"X-Kinvey-Device-Information":G()}};return c.Log.getLevel()===c.Log.levels.TRACE&&(f.headers["X-Kinvey-Trace-Request"]="true",f.headers["X-Kinvey-Force-Debug-Log-Credentials"]="true"),f.auth().then(function(a){if(null!==a){var b=a.credentials;null!=a.username&&(b=c.Persistence.Net.base64(a.username+":"+a.password)),f.headers.Authorization=a.scheme+" "+b}return c.Persistence.Net.request(f.method,f.url,Q.encodeFormData(f.data),f.headers,e)}).then(function(a){try{a=JSON.parse(a)}catch(b){}return a})},connect:function(a,b,d){return a=a||{},c.setActiveUser(null),a._socialIdentity={},a._socialIdentity[Q.AUTH_PROVIDER]={access_token:b},c.User.login(a,null,d).then(null,function(e){return d.create&&c.Error.USER_NOT_FOUND===e.name?c.User.signup(a,d).then(function(a){return Q.connect(a,b,d)}):c.Defer.reject(e)})},disconnect:function(){return D.destroy(Q.TOKEN_STORAGE_KEY)},encodeFormData:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},isHTML5:function(){return!(this.isTitanium()||this.isNode())},isAngular:function(){return"undefined"!=typeof a.angular},isBackbone:function(){return"undefined"!=typeof a.Backbone},isPhoneGap:function(){return"undefined"!=typeof a.cordova&&"undefined"!=typeof a.device},isTitanium:function(){return"undefined"!=typeof Titanium},isNode:function(){return"undefined"!=typeof process&&"undefined"!=typeof require}};c.User=c.User||{},c.User.MIC={loginWithAuthorizationCodeLoginPage:function(a,b){return Q.login(Q.AuthorizationGrant.AuthorizationCodeLoginPage,a,b)},loginWithAuthorizationCodeAPI:function(a,b,c,d){return d=d||{},d.username=a,d.password=b,Q.login(Q.AuthorizationGrant.AuthorizationCodeAPI,c,d)},logout:function(a){return c.User.logout(a)}},c.Query=function(a){a=a||{},this._fields=a.fields||[],this._filter=a.filter||{},this._sort=a.sort||{},this._limit=a.limit||null,this._skip=a.skip||0,this._parent=null},c.Query.prototype={equalTo:function(a,b){return this._filter[a]=b,this},contains:function(a,b){if(!s(b))throw new c.Error("values argument must be of type: Array.");return this._addFilter(a,"$in",b)},containsAll:function(a,b){if(!s(b))throw new c.Error("values argument must be of type: Array.");return this._addFilter(a,"$all",b)},greaterThan:function(a,b){if(!u(b)&&!x(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$gt",b)},greaterThanOrEqualTo:function(a,b){if(!u(b)&&!x(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$gte",b)},lessThan:function(a,b){if(!u(b)&&!x(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$lt",b)},lessThanOrEqualTo:function(a,b){if(!u(b)&&!x(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$lte",b)},notEqualTo:function(a,b){return this._addFilter(a,"$ne",b)},notContainedIn:function(a,b){if(!s(b))throw new c.Error("values argument must be of type: Array.");return this._addFilter(a,"$nin",b)},and:function(){return this._join("$and",Array.prototype.slice.call(arguments))},nor:function(){return null!==this._parent&&null!=this._parent._filter.$and?this._parent.nor.apply(this._parent,arguments):this._join("$nor",Array.prototype.slice.call(arguments))},or:function(){return null!==this._parent?this._parent.or.apply(this._parent,arguments):this._join("$or",Array.prototype.slice.call(arguments))},exists:function(a,b){return b="undefined"==typeof b?!0:b||!1,this._addFilter(a,"$exists",b)},mod:function(a,b,d){if(x(b)&&(b=parseFloat(b)),"undefined"==typeof d?d=0:x(d)&&(d=parseFloat(d)),!u(b))throw new c.Error("divisor arguments must be of type: number.");if(!u(d))throw new c.Error("remainder argument must be of type: number.");return this._addFilter(a,"$mod",[b,d])},matches:function(a,b,c){if(w(b)||(b=new RegExp(b)),c=c||{},(b.ignoreCase||c.ignoreCase)&&!1!==c.ignoreCase)throw new Error("ignoreCase flag is not supported.");if(0!==b.source.indexOf("^"))throw new Error("regExp must be an anchored expression.");var d=[];(b.multiline||c.multiline)&&!1!==c.multiline&&d.push("m"),c.extended&&d.push("x"),c.dotMatchesAll&&d.push("s");var e=this._addFilter(a,"$regex",b.source);return 0!==d.length&&this._addFilter(a,"$options",d.join("")),e},near:function(a,b,d){if(!s(b)||null==b[0]||null==b[1])throw new c.Error("coord argument must be of type: Array.<number, number>.");b[0]=parseFloat(b[0]),b[1]=parseFloat(b[1]);var e=this._addFilter(a,"$nearSphere",[b[0],b[1]]);return null!=d&&this._addFilter(a,"$maxDistance",d),e},withinBox:function(a,b,d){if(!s(b)||null==b[0]||null==b[1])throw new c.Error("bottomLeftCoord argument must be of type: Array.<number, number>.");if(!s(d)||null==d[0]||null==d[1])throw new c.Error("upperRightCoord argument must be of type: Array.<number, number>.");b[0]=parseFloat(b[0]),b[1]=parseFloat(b[1]),d[0]=parseFloat(d[0]),d[1]=parseFloat(d[1]);var e=[[b[0],b[1]],[d[0],d[1]]];return this._addFilter(a,"$within",{$box:e})},withinPolygon:function(a,b){if(!s(b)||3>b.length)throw new c.Error("coords argument must be of type: Array.Array.<number, number>.");return b=b.map(function(a){if(null==a[0]||null==a[1])throw new c.Error("coords argument must be of type: Array.Array.<number, number>.");return[parseFloat(a[0]),parseFloat(a[1])]}),this._addFilter(a,"$within",{$polygon:b})},size:function(a,b){if(x(b)&&(b=parseFloat(b)),!u(b))throw new c.Error("size argument must be of type: number.");return this._addFilter(a,"$size",b)},fields:function(a){if(a=a||[],!s(a))throw new c.Error("fields argument must be of type: Array.");return null!==this._parent?this._parent.fields(a):this._fields=a,this},limit:function(a){if(a=a||null,x(a)&&(a=parseFloat(a)),null!=a&&!u(a))throw new c.Error("limit argument must be of type: number.");return null!==this._parent?this._parent.limit(a):this._limit=a,this},skip:function(a){if(x(a)&&(a=parseFloat(a)),!u(a))throw new c.Error("skip argument must be of type: number.");return null!==this._parent?this._parent.skip(a):this._skip=a,this},ascending:function(a){return null!==this._parent?this._parent.ascending(a):this._sort[a]=1,this},descending:function(a){return null!==this._parent?this._parent.descending(a):this._sort[a]=-1,this},sort:function(a){if(null!=a&&!v(a))throw new c.Error("sort argument must be of type: Object.");return null!==this._parent?this._parent.sort(a):this._sort=a||{},this},toJSON:function(){return null!==this._parent?this._parent.toJSON():{fields:this._fields,filter:this._filter,sort:this._sort,skip:this._skip,limit:this._limit}},_addFilter:function(a,b,c){return v(this._filter[a])||(this._filter[a]={}),this._filter[a][b]=c,this},_join:function(a,b){var d=this;b=b.map(function(a){if(!(a instanceof c.Query)){if(!v(a))throw new c.Error("query argument must be of type: Kinvey.Query[] or Object[].");a=new c.Query(a)}return a.toJSON().filter}),0===b.length&&(d=new c.Query,b=[d.toJSON().filter],d._parent=this);var e={};for(var f in this._filter)this._filter.hasOwnProperty(f)&&(e[f]=this._filter[f],delete this._filter[f]);return this._filter[a]=[e].concat(b),d},_postProcess:function(a){if(!s(a))throw new c.Error("response argument must be of type: Array.");var b=this;return a=a.sort(function(a,c){for(var d in b._sort)if(b._sort.hasOwnProperty(d)){var e=q(a,d),f=q(c,d);if(null!=e&&null==f)return-1;if(null!=f&&null==e)return 1;if(e!==f){var g=b._sort[d];return(f>e?-1:1)*g}}return 0}),null!==this._limit?a.slice(this._skip,this._skip+this._limit):a.slice(this._skip)}};var R=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},S={get:function(a,b){if(d.debug("Retrieving relations for a document.",a,b),s(a)){var e=a.map(function(a){return S.get(a,R(b))});return c.Defer.all(e)}b=b||{},b.exclude=b.exclude||[],b.relations=b.relations||{};var f=b.error,g=b.relations,h=b.success;delete b.error,delete b.relations,delete b.success;var j={};Object.keys(g).forEach(function(a){var b=j,c=a.split("."),d=c.length;c.forEach(function(a,c){b.keys||(b.keys={}),b.keys[a]||(b.keys[a]={}),b=b.keys[a],c===d-1&&(b.resolve=!0)})});var k=function(a,d){var e;if(d.keys){var f=[];return Object.keys(d.keys).forEach(function(g){var h=d.keys[g];if(h.resolve){var j=s(a[g]),l=(j?a[g]:[a[g]]).map(function(a){if(null==a||"KinveyRef"!==a._type)return c.Defer.resolve(a);if(null==a._id)return e=new c.Error("Member does not have _id property defined. It is required to resolve the relationship."),c.Defer.reject(e);var d;return d=i===a._collection?c.User.get(a._id,b):c.DataStore.get(a._collection,a._id,b),d.then(function(a){return k(a,h).then(function(){return a},function(){return a})},function(){return c.Defer.resolve(a)})});f.push(c.Defer.all(l).then(function(b){a[g]=j?b:b[0]}))}else f.push(k(a[g],h))}),c.Defer.all(f)}return c.Defer.resolve()},l=k(a,j);return l.then(function(){return d.debug("Retrieved relations for the document.",a),b.error=f,b.relations=g,b.success=h,a},function(e){return d.error("Failed to retrieve relations for the document.",a),b.error=f,b.relations=g,b.success=h,c.Defer.reject(e)})},save:function(a,b,e){if(d.debug("Saving a document with relations.",a,b,e),s(b)){var f=b.map(function(b){return S.save(a,b,R(e))});return c.Defer.all(f)}e=e||{},e.exclude=e.exclude||[],e.relations=e.relations||{};var g=e.error,h=e.relations,j=e.success;delete e.error,delete e.relations,delete e.success;var k=[];h[""]=a,Object.keys(h).forEach(function(a){var b=""===a?0:a.split(".").length;k[b]=(k[b]||[]).concat(a)});var l={},m=c.Defer.resolve(null);return k.reverse().forEach(function(a){m=m.then(function(){var d=a.map(function(a){var d=h[a],f=q(b,a),g=s(f),j=(g?f:[f]).map(function(b){if(null==b||"KinveyRef"===b._type||-1!==e.exclude.indexOf(a))return c.Defer.resolve(b);var f,g=e.offline&&!1===e.track;if(i!==d||g)f=c.DataStore.save(d,b,e);else{var h=null==b._id;e.state=h&&""!==a?e.state||!1:e.state,f=c.User[h?"create":"update"](b,e)}return f.then(null,function(d){return e.force&&""!==a?b:c.Defer.reject(d)})});return c.Defer.all(j).then(function(c){var e=c.map(function(a){return null==a||null==a._id?a:{_type:"KinveyRef",_collection:d,_id:a._id}});g||(e=e[0],c=c[0]),q(b,a,e),l[a]=c})});return c.Defer.all(d)})}),m.then(function(){var a=l[""];return k.reverse().forEach(function(b){b.forEach(function(b){q(a,b,l[b])})}),d.debug("Saved the document with relations.",a),delete h[""],e.error=g,e.relations=h,e.success=j,a},function(a){return d.error("Failed to save the document with relations.",g),delete h[""],e.error=g,e.relations=h,e.success=j,c.Defer.reject(a)})}},T=function(a){var b=c.Sync.isEnabled(),d=c.Sync.isOnline();return a.fallback=b&&d&&!1!==a.fallback,a.offline=b&&(!d||a.offline),a.refresh=b&&d&&!1!==a.refresh,a.handler="function"==typeof a.handler?a.handler:function(){},a},U={addMetadata:function(a,b){var c=(new Date).toISOString(),d=s(a),e=d?a:[a];return e=e.map(function(a){return null!=a&&(a._kmd=a._kmd||{},a._kmd.lastRefreshedAt=c,null!=b&&(a._kmd.maxAge=b)),a}),d?e:e[0]},removeMetadata:function(a){var b=s(a),c=b?a:[a];return c=c.map(function(a){return null!=a&&null!=a._kmd&&(delete a._kmd.lastRefreshedAt,delete a._kmd.maxAge),a}),b?c:c[0]},status:function(a,b){for(var d=!1,e=s(a)?a:[a],f=e.length,g=(new Date).getTime(),h=0;f>h;h+=1){var i=e[h];if(null==i._kmd){var j=new c.Error("The item does not have _kmd defined as a property.It is required to get the maxAge status.");throw j}if(null!=i&&null!=i._kmd&&null!=i._kmd.lastRefreshedAt){var k=1e3*(b||i._kmd.maxAge),l=N(i._kmd.lastRefreshedAt).getTime(),m=l+k;if(g>m)return!1;var n=l+.9*k;g>n&&(d=!0)}}return d?{refresh:!0}:!0}};c.Persistence={create:function(a,b){if(b.relations){var e=i===a.namespace?i:a.collection;return S.save(e,a.data,b)}if(a.local=a.local||{},b=T(b),a.local.req&&b.offline)return d.debug("Using local persistence."),c.Persistence.Local.create(a,b).then(null,function(e){return b.fallback&&"_group"===a.id?(d.debug("Local persistence failed. Use net persistence because of the fallback flag."),b.offline=!1,c.Persistence.create(a,b)):c.Defer.reject(e)});d.debug("Using net persistence.");var f=c.Persistence.Net.create(a,b);return a.local.res&&b.refresh?(d.debug("Persisting the response locally."),f.then(function(d){return a.data=d,c.Persistence.Local.create(a,b).then(function(){return d})})):f},read:function(a,b){if(a.local=a.local||{},b=T(b),a.local.req&&b.offline)return d.debug("Using local persistence."),c.Persistence.Local.read(a,b).then(null,function(e){return b.fallback?(d.debug("Local persistence failed. Use net persistence because of the fallback flag."),b.offline=!1,c.Persistence.read(a,b)):c.Defer.reject(e)});d.debug("Using net persistence.");var e=c.Persistence.Net.read(a,b),f=b.fields||a.query&&!y(a.query._fields);return a.local.res&&b.refresh&&!f?e.then(function(e){d.debug("Persisting the response locally.");var f;if(b.relations){var g=b.offline;b.offline=!0,b.track=!1;var h=i===a.namespace?i:a.collection;f=S.save(h,e,b).then(function(){b.offline=g,delete b.track})}else a.data=e,f=c.Persistence.Local.create(a,b);return f.then(function(){return e})},function(d){return c.Error.ENTITY_NOT_FOUND===d.name?c.Persistence.Local.destroy(a,b).then(function(){return c.Defer.reject(d)}):c.Defer.reject(d)}):e},update:function(a,b){if(b.relations){var e=i===a.namespace?i:a.collection;return S.save(e,a.data,b)}if(a.local=a.local||{},b=T(b),a.local.req&&b.offline)return d.debug("Using local persistence."),c.Persistence.Local.update(a,b);d.debug("Using net persistence..");var f=c.Persistence.Net.update(a,b);return a.local.res&&b.refresh?(d.debug("Persisting the response locally."),f.then(function(d){return a.data=d,c.Persistence.Local.update(a,b).then(function(){return d})})):f},destroy:function(a,b){if(a.local=a.local||{},b=T(b),a.local.req&&b.offline)return d.debug("Using local persistence."),c.Persistence.Local.destroy(a,b);d.debug("Using net persistence.");var e=c.Persistence.Net.destroy(a,b);return a.local.res&&b.refresh?(d.debug("Persisting the response locally."),e.then(function(d){return c.Persistence.Local.destroy(a,b).then(function(){return d},function(a){return c.Error.ENTITY_NOT_FOUND===a.name?d:c.Defer.reject(a)})})):e}};var V={version:1,versionTable:"KinveyDatabaseVersion",upgrade:function(){try{return V.find(V.versionTable).then(null,function(){return[void 0]}).then(function(a){var b=a[0]||{};return V.onUpgrade(b.version,V.version).then(function(){return b})}).then(function(a){return a.version=V.version,V.save(V.versionTable,a)}).then(function(){})}catch(a){return c.Defer.resolve()}},onUpgrade:function(a,b){var d=c.Defer.deferred(),e=null==a?1:a+1;return b>=e?V.onUpgrade(e,b):(d.resolve(),d.promise)},batch:z("Database.batch"),clean:z("Database.clean"),count:z("Database.count"),destroy:z("Database.destroy"),destruct:z("Database.destruct"),find:z("Database.find"),findAndModify:z("Database.findAndModify"),get:z("Database.get"),group:z("Database.group"),save:z("Database.save"),update:z("Database.update"),isTemporaryObjectID:z("Database.isTemporaryObjectID"),use:A(["batch","clean","count","destroy","destruct","find","findAndModify","get","group","save","update","isTemporaryObjectID"])};c.Persistence.Local={create:function(a,b){d.debug("Initiating a create request.",arguments),b=b||{};var c=i===a.namespace?i:a.collection;if("_group"===a.id)return V.group(c,a.data,b);a.data=U.addMetadata(a.data,b.maxAge);var e=s(a.data)?"batch":"save",f=V[e](c,a.data,b);return f.then(function(a){return b.offline&&!1!==b.track?(d.debug("Notifying the synchronization functionality.",c,a),X.notify(c,a,b).then(function(){return a})):a})},read:function(a,b){var e;d.debug("Initiating a read request.",arguments),b=b||{};var f=i===a.namespace?i:a.collection;if("_count"===a.id)return V.count(f,a.query,b);if("_me"===a.collection){var g=c.getActiveUser();return null!==g?null==g._id?(e=new c.Error("Active user does not have the _id property defined. Unable to retrieve information about the user."),c.Defer.reject(e)):V.get(f,g._id,b).then(null,function(a){return a.name===c.Error.ENTITY_NOT_FOUND?g:c.Defer.reject(a)}):(e=p(c.Error.NO_ACTIVE_USER),c.Defer.reject(e))}var h;return h=null==a.id?V.find(f,a.query,b):V.get(f,a.id,b),h.then(function(d){var e=U.status(d,b.maxAge);return!1===e&&c.Sync.isOnline()?(b.offline=!1,c.Persistence.read(a,b)):b.relations?S.get(d,b).then(function(d){return!0===e.refresh&&c.Sync.isOnline()&&(b.offline=!1,c.Persistence.read(a,b)),d}):(!0===e.refresh&&c.Sync.isOnline()&&(b.offline=!1,c.Persistence.read(a,b)),d)})},update:function(a,b){d.debug("Initiating an update request.",arguments),b=b||{};var c=i===a.namespace?i:a.collection;a.data=U.addMetadata(a.data,b.maxAge);var e=V.update(c,a.data,b);return e.then(function(a){return b.offline&&!1!==b.track?(d.debug("Notifying the synchronization functionality.",c,a),X.notify(c,a,b).then(function(){return a})):a})},destroy:function(a,b){d.debug("Initiating a delete request.",arguments),b=b||{};var c,e=i===a.namespace?i:a.collection;return c=null==a.id?V.clean(e,a.query,b):V.destroy(e,a.id,b),c.then(function(a){return b.offline&&!1!==b.track?(d.debug("Notifying the synchronization functionality.",e,a),X.notify(e,a.documents,b).then(function(){return a})):a})}};var W=null;c.Persistence.Net={create:function(a,b){return d.debug("Initiating a create request.",arguments),a.data=U.removeMetadata(a.data),a.method="POST",c.Persistence.Net._request(a,b)},read:function(a,b){if(d.debug("Initiating a read request.",arguments),
a.flags=a.flags||{},b=b||{},s(b.fields)&&(a.flags.fields=b.fields.join(",")),null!=a.collection&&(!1!==b.fileTls&&(a.flags.kinveyfile_tls=!0),b.fileTtl&&(a.flags.kinveyfile_ttl=b.fileTtl)),b.relations){b.exclude=b.exclude||[];var e=Object.keys(b.relations).filter(function(a){return-1===b.exclude.indexOf(a)});0!==e.length&&(a.flags.retainReferences=!1,a.flags.resolve=e.join(","))}return a.method="GET",c.Persistence.Net._request(a,b)},update:function(a,b){return d.debug("Initiating an update request.",arguments),a.data=U.removeMetadata(a.data),a.method="PUT",c.Persistence.Net._request(a,b)},destroy:function(a,b){return d.debug("Initiating a delete request.",arguments),a.method="DELETE",c.Persistence.Net._request(a,b)},_request:function(a,b){var e;if(null==a.method)return e=new c.Error("request argument must contain: method."),r(c.Defer.reject(e),b);if(null==a.namespace)return e=new c.Error("request argument must contain: namespace."),r(c.Defer.reject(e),b);if(null==a.auth)return e=new c.Error("request argument must contain: auth."),r(c.Defer.reject(e),b);if(null==c.appKey&&F.None!==a.auth)return e=p(c.Error.MISSING_APP_CREDENTIALS),r(c.Defer.reject(e),b);if(null==c.masterSecret&&b.skipBL)return e=p(c.Error.MISSING_MASTER_CREDENTIALS),r(c.Defer.reject(e),b);b.trace=b.trace||c.Log.getLevel()===c.Log.levels.TRACE&&!1!==b.trace,b.attemptMICRefresh=!1===b.attemptMICRefresh?!1:!0;var f=[a.namespace,c.appKey,a.collection,a.id];f=f.filter(function(a){return null!=a}).map(c.Persistence.Net.encode);var g=[c.APIHostName].concat(f).join("/")+"/",h=a.flags||{};if(a.query){var i=a.query.toJSON();h.query=i.filter,y(i.fields)||(h.fields=i.fields.join(",")),null!==i.limit&&(h.limit=i.limit),0!==i.skip&&(h.skip=i.skip),y(i.sort)||(h.sort=i.sort)}!1!==b.nocache&&(h._=Math.random().toString(36).substr(2));var k=[];for(var l in h)if(h.hasOwnProperty(l)){var m=x(h[l])?h[l]:JSON.stringify(h[l]);k.push(c.Persistence.Net.encode(l)+"="+c.Persistence.Net.encode(m))}0<k.length&&(g+="?"+k.join("&")),null===W&&(W=G());var n={Accept:"application/json","X-Kinvey-API-Version":c.API_VERSION,"X-Kinvey-Device-Information":W};b.clientAppVersion=b.clientAppVersion||c.ClientAppVersion.stringValue(),null!=b.clientAppVersion&&(n["X-Kinvey-Client-App-Version"]=b.clientAppVersion+""),null!=a.data&&(n["Content-Type"]="application/json; charset=utf-8"),b.contentType&&(n["X-Kinvey-Content-Type"]=b.contentType),b.skipBL&&(n["X-Kinvey-Skip-Business-Logic"]="true"),b.trace&&(n["X-Kinvey-Include-Headers-In-Response"]="X-Kinvey-Request-Id",n["X-Kinvey-ResponseWrapper"]="true"),b.customRequestProperties=b.customRequestProperties||{};var o=c.CustomRequestProperties.properties();if(null!=o&&Object.keys(o).forEach(function(a){b.customRequestProperties.hasOwnProperty(a)||(b.customRequestProperties[a]=o[a])}),Object.getOwnPropertyNames(b.customRequestProperties).length>0){var q=JSON.stringify(b.customRequestProperties),t=B(q);if(t>=j)return e=new c.Error("Custom request properties is "+t+" bytes. It must be less then "+j+" bytes."),r(c.Defer.reject(e),b);n["X-Kinvey-Custom-Request-Properties"]=q}c.Log.getLevel()===c.Log.levels.TRACE&&(n["X-Kinvey-Trace-Request"]="true");var u=a.auth().then(function(a){if(null!==a){var b=a.credentials;null!=a.username&&(b=c.Persistence.Net.base64(a.username+":"+a.password)),n.Authorization=a.scheme+" "+b}});return u.then(function(){b._originalRequest=a;var e=c.Persistence.Net.request(a.method,g,a.data,n,b).then(function(e){try{e=JSON.parse(e)}catch(f){}if(b.trace&&v(e)&&d.debug("Obtained the request ID.",e.headers["X-Kinvey-Request-Id"]),"GET"===a.method&&null!=a.collection&&"appdata"===a.namespace){var h,i=null!=a.id?!0:!1,j=b.trace&&v(e)?e.result:e;if(s(j)&&i)throw h=new c.Error("Expected a single entity as a response to "+a.method+" "+g+". Received an array of entities instead.");if(!s(j)&&!i)throw h=new c.Error("Expected an array of entities as a response to "+a.method+" "+g+". Received a single entity instead.")}return b.trace&&v(e)?e.result:e},function(a){try{a=JSON.parse(a)}catch(e){}var f=null;if(b.trace&&(f=a.headers["X-Kinvey-Request-Id"],a=a.result),null!=a&&null!=a.error)a={name:a.error,description:a.description||"",debug:a.debug||""},b.trace&&(a.requestId=f,d.debug("Obtained the request ID.",f));else{var g={abort:c.Error.REQUEST_ABORT_ERROR,error:c.Error.REQUEST_ERROR,timeout:c.Error.REQUEST_TIMEOUT_ERROR};a=p(g[a]||g.error,{debug:a})}return c.Defer.reject(a)});return e.then(null,function(a){if(c.Error.USER_LOCKED_DOWN===a.name){if(c.setActiveUser(null),"undefined"!=typeof V){var b=function(){c.Defer.reject(a)};return c.Sync.destruct().then(b,b)}}else if(c.Error.INVALID_CREDENTIALS===a.name){var d=c.getActiveUser();a.debug+=null!=d&&null!=d._socialIdentity&&null!=d._socialIdentity[Q.AUTH_PROVIDER]?" It is possible the tokens used to execute the request are expired. In that case, please execute `Kinvey.User.logout({ force: true })`, and then log back in using `Kinvey.User.MIC.loginWithAuthorizationCodeLoginPage(redirectUri)` or `Kinvey.User.MIC.loginWithAuthorizationCodeAPI(username, password, redirectUri)` to solve this issue.":" It is possible the tokens used to execute the request are expired. In that case, please execute `Kinvey.User.logout({ force: true })`, and then log back in using `Kinvey.User.login(username, password)` to solve this issue."}return c.Defer.reject(a)})})},base64:z("Kinvey.Persistence.Net.base64"),encode:z("Kinvey.Persistence.Net.encode"),request:z("Kinvey.Persistence.Net.request"),use:A(["base64","encode","request"])};var X={enabled:!1,online:!0,system:"system.sync",count:function(a,b){if(b=b||{},null!=a)return V.get(X.system,a,b).then(function(a){return a.size},function(a){return c.Error.ENTITY_NOT_FOUND===a.name?0:c.Defer.reject(a)});var d=c.Group.sum("size").toJSON();return V.group(X.system,d,b).then(function(a){return a[0]?a[0].result:0})},execute:function(a){var b=(new c.Query).greaterThan("size",0);return V.find(X.system,b,a).then(function(b){var d=b.map(function(b){return X._collection(b._id,b.documents,a)});return c.Defer.all(d)})},notify:function(a,b,d){var e;return V.findAndModify(X.system,a,function(f){return b=s(b)?b:[b],f=f||{_id:a,documents:{},size:0},b.forEach(function(a){if(null==a._id)throw e=new c.Error("Document does not have _id property defined. It is required to do proper synchronization.");f.documents.hasOwnProperty(a._id)||(f.size+=1);var b=null!=a._kmd?a._kmd.lmt:null,g=d.clientAppVersion||c.ClientAppVersion.stringValue(),h=d.customRequestProperties||{},i=c.CustomRequestProperties.properties();null!=i&&Object.keys(i).forEach(function(a){h.hasOwnProperty(a)||(h[a]=i[a])}),f.documents[a._id]={timestamp:b,clientAppVersion:g,customRequestProperties:h}}),f},d).then(function(){return null})},_collection:function(a,b,d){var e={collection:a,success:[],error:[]},f=Object.keys(b);return X._read(a,b,d).then(function(g){var h=f.map(function(c){var f=b[c]||{},h={id:c,timestamp:f.timestamp,clientAppVersion:f.clientAppVersion,customRequestProperties:f.customRequestProperties};return X._document(a,h,g.local[c]||null,g.net[c]||null,d).then(null,function(a){return e.error.push({id:a.id,error:a}),null})});return c.Defer.all(h)}).then(function(b){var e=b.filter(function(a){return null!=a&&null!==a.document}),f=b.filter(function(a){return null!=a&&null===a.document}),g=[X._save(a,e,d),X._destroy(a,f,d)];return c.Defer.all(g)}).then(function(b){return e.success=e.success.concat(b[0].success,b[1].success),e.error=e.error.concat(b[0].error,b[1].error),V.findAndModify(X.system,a,function(a){e.success.forEach(function(b){a.documents.hasOwnProperty(b)&&(a.size-=1,delete a.documents[b])});try{var b=Object.keys(a.documents);b.forEach(function(b){a.documents.hasOwnProperty(b)&&-1===e.error.indexOf(b)&&(a.size-=1,delete a.documents[b])})}catch(c){}return a},d)}).then(function(){return e})},_read:function(a,b,d){var e=Object.keys(b),g=e.map(function(e){var g=b[e],h=d||{};h.clientAppVersion=null!=g&&null!=g.clientAppVersion?g.clientAppVersion:null,h.customRequestProperties=null!=g&&null!=g.customRequestProperties?g.customRequestProperties:null;var j={namespace:i===a?i:f,collection:i===a?null:a,query:(new c.Query).contains("_id",[e]),auth:F.Default};return c.Defer.all([c.Persistence.Local.read(j,h),c.Persistence.Net.read(j,h)]).then(function(a){return{local:a[0],net:a[1]}})});return c.Defer.all(g).then(function(a){var b,d={local:{},net:{}};return a.forEach(function(a){var e=a.local,f=a.net;e.forEach(function(a){if(null==a._id)throw b=new c.Error("Document does not have _id property defined. It is required to do proper synchronization.");d.local[a._id]=a}),f.forEach(function(a){if(null==a._id)throw b=new c.Error("Document does not have _id property defined. It is required to do proper synchronization.");d.net[a._id]=a})}),d})},_destroy:function(a,b,d){var e=b.map(function(b){var e=b.id,g=b.metadata,h=d||{};h.clientAppVersion=null!=g.clientAppVersion?g.clientAppVersion:null,h.customRequestProperties=null!=g.customRequestProperties?g.customRequestProperties:null;var j={namespace:i===a?i:f,collection:i===a?null:a,query:(new c.Query).contains("_id",[e]),auth:F.Default},k=[c.Persistence.Local.destroy(j,h),c.Persistence.Net.destroy(j,h)];return c.Defer.all(k).then(function(){return{success:[e],error:[]}},function(a){return{success:[],error:[{id:e,error:a}]}})});return c.Defer.all(e).then(function(a){var b={success:[],error:[]};return a.forEach(function(a){b.success=b.success.concat(a.success),b.error=b.error.concat(a.error)}),b})},_document:function(a,b,d,e,f){var g;return null==b?(g=new c.Error("Missing required metadata for the document in collection "+a+". This is required to properly sync."),c.Defer.reject(g)):null==b.id?(g=new c.Error("Metadata does not have id defined. This is required to properly sync the document in collection "+a+"."),c.Defer.reject(g)):null===e||null!=e._kmd&&b.timestamp===e._kmd.lmt?c.Defer.resolve({id:b.id,document:d,metadata:b}):null!=f.conflict?f.conflict(a,d,e).then(function(a){return{id:b.id,document:a,metadata:b}},function(){return c.Defer.reject({id:b.id,document:[d,e],metadata:b})}):c.Defer.reject({id:b.id,document:[d,e],metadata:b})},_save:function(a,b,d){var e=[],g=b.map(function(b){var g=b.document,h=b.metadata,j=d||{},k=g._id;return j.clientAppVersion=null!=h.clientAppVersion?h.clientAppVersion:null,j.customRequestProperties=null!=h.customRequestProperties?h.customRequestProperties:null,V.isTemporaryObjectID(k)?(delete g._id,c.Persistence.Net.create({namespace:i===a?i:f,collection:i===a?null:a,data:g,auth:F.Default},j).then(function(b){return V.destroy(a,k).then(function(){return b})},function(a){return g._id=k,e.push({id:g._id,error:a}),null})):c.Persistence.Net.update({namespace:i===a?i:f,collection:i===a?null:a,id:g._id,data:g,auth:F.Default},j).then(null,function(a){return e.push({id:g._id,error:a}),null})});return c.Defer.all(g).then(function(b){return c.Persistence.Local.create({namespace:i===a?i:f,collection:i===a?null:a,data:b,auth:F.Default},d)}).then(function(a){return{success:a.map(function(a){return a._id}),error:e}},function(a){return{success:[],error:b.map(function(b){return{id:b._id,error:a}})}})}};c.Sync={count:function(a,b){d.debug("Counting the number of documents pending synchronization.",arguments),b=b||{};var c=X.count(a,b);return c.then(function(a){d.debug("Counted the number of documents pending synchronization.",a)},function(a){d.error("Failed to count the number of documents pending synchronization.",a)}),r(c,b)},destruct:function(a){d.debug("Deleting the local database.",arguments),a=a||{};var b=V.destruct(a);return b.then(function(a){d.debug("Deleted the local database.",a)},function(a){d.error("Failed to delete the local database.",a)}),r(b,a)},execute:function(a){if(d.debug("Synchronizing the application.",arguments),!c.Sync.isOnline()){var b=p(c.Error.SYNC_ERROR,{debug:"Sync is not enabled, or the application resides in offline mode."});return c.Defer.reject(b)}a=a||{};var e;return null!=a.user?(d.debug("Attempting to login with a user context.",a.user),e=c.User.login(a.user).then(function(){return delete a.user,c.Sync.execute(a)}),e.then(null,function(a){d.error("Failed to login with the user context.",a)}),delete a.success,r(e,a)):(e=X.execute(a),e.then(function(a){d.debug("Synchonized the application.",a)},function(a){d.error("Failed to synchronize the application.",a)}),r(e,a))},init:function(a){return d.debug("Initializing the synchronization functionality.",arguments),a=a||{},X.enabled="undefined"!=typeof a.enable?a.enable:X.enabled,X.online="undefined"!=typeof a.online?a.online:X.online,c.Defer.resolve(null)},isEnabled:function(){return X.enabled},isOnline:function(){return X.online},offline:function(){if(d.debug("Switching the application state to offline."),!c.Sync.isEnabled()){var a=p(c.Error.SYNC_ERROR,{debug:"Sync is not enabled."});return c.Defer.reject(a)}return X.online=!1,c.Defer.resolve(null)},online:function(a){if(d.debug("Switching the application state to online.",arguments),!c.Sync.isEnabled()){var b=p(c.Error.SYNC_ERROR,{debug:"Sync is not enabled."});return c.Defer.reject(b)}a=a||{};var e=X.online;return X.online=!0,!1!==a.sync&&e!==X.online?c.Sync.execute(a):c.Defer.resolve(null)},clientAlwaysWins:function(a,b){return c.Defer.resolve(b)},serverAlwaysWins:function(a,b,d){return c.Defer.resolve(d)}},"function"!=typeof setImmediate&&(setImmediate=process.nextTick);var Y=require("promiscuous");c.Defer.use({deferred:function(){var a={};return a.promise=new Y(function(b,c){a.resolve=b,a.reject=c}),a}});var Z={url:require("url"),base64:function(a){return new Buffer(a,"utf-8").toString("base64")},encode:encodeURIComponent,request:function(a,b,e,f,g){e=e||null,f=f||{},g=g||{},g.attemptMICRefresh=!1===g.attemptMICRefresh?!1:!0;var h=c.Defer.deferred(),i=0;e instanceof Buffer?i=e.length:null!=e&&(x(e)||(e=JSON.stringify(e)),i=Buffer.byteLength(e)),f["Content-Length"]=i;var j=Z.url.parse(b),k=require("https:"===j.protocol?"https":"http"),l=k.request({host:j.hostname,path:j.pathname+(j.search?j.search:""),port:j.port,method:a,headers:f},function(a){var b=[];a.on("data",function(a){b.push(new Buffer(a))}),a.on("end",function(){d.debug("The network request completed.",a);var e=Buffer.concat(b),f=a.statusCode;if(!g.file&&""!==e.toString()&&2===parseInt(f/100,10)&&204!==f){var i,k=a.headers["content-type"];if(null==k?i=new c.Error("Content-Type header missing in response. Please add Content-Type header to response with value application/json."):-1===k.indexOf("application/json")&&(i=new c.Error("Response Content-Type header is set to "+k+". Expected it to be set to application/json.")),i)return h.reject(i)}if(3===parseInt(f/100,10)&&304!==f){if(0===(j.protocol+"//"+j.hostname).indexOf(c.MICHostName)){var l=a.headers.location,m=Z.url.parse(l);return h.resolve(C(m.search))}g.file||(e=e.toString()||null),h.resolve(e)}else if(2===parseInt(f/100,10)||304===f)g.file||(e=e.toString()||null),h.resolve(e);else{var n,o=g._originalRequest;n=401===f&&g.attemptMICRefresh?Q.refresh(g):c.Defer.reject(),n.then(function(){return g.attemptMICRefresh=!1,c.Persistence.Net._request(o,g)}).then(function(a){h.resolve(a)},function(){var a=e.toString()||null;Array.isArray(a)&&(a=new c.Error("Received an array as a response with a status code of "+f+". A JSON object is expected as a response to requests that result in an error status code.")),h.reject(a)})}})}),m=!1;0<g.timeout&&l.on("socket",function(a){a.setTimeout(g.timeout),a.on("timeout",function(){m=!0,l.abort()})});var n=!1,o={cancel:function(){n=!0,l.abort()}};return l.on("error",function(a){return d.error("The network request failed.",a),m?h.reject("timeout"):n?h.reject("canceled"):void h.reject(a)}),d.debug("Initiating a network request.",a,j,e,f,g),null!=e&&l.write(e),l.end(),g.handler(o),h.promise}};c.Persistence.Net.use(Z);var $={},_={_destroy:function(a){return delete $[a],c.Defer.resolve(null)},_get:function(a){return c.Defer.resolve($[a]||null)},_save:function(a,b){return $[a]=b,c.Defer.resolve(null)}};return D.use(_),c},c=b();"object"==typeof module&&"object"==typeof module.exports?module.exports=c:"function"==typeof define&&define.amd?define("kinvey",[],function(){return c}):a.Kinvey=c}).call(this);